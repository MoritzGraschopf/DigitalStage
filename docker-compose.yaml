services:
    app:
        image: digitalstage.liveroom.at/digitalstage-app:latest
        container_name: digitalstage_app
        restart: unless-stopped
        env_file: [ .env ]
        environment:
            - DATABASE_URL=postgresql://digitalstage:digitalStage123@db:5432/digitalstage
        expose: [ "3000" ]
        depends_on: [ db ]
        command: sh -c "npx prisma migrate deploy && npm start"

    websocket:
        image: digitalstage.liveroom.at/digitalstage-websocket:latest
        container_name: digitalstage_websocket
        restart: unless-stopped
        env_file: [ .env ]
        depends_on: [ db ]
        volumes:
            - ./certs:/app/certs:ro
            - /opt/digitalstage/sdp:/sdp
        ports:
            - "3010:3010"
            - "40000-40100:40000-40100"
        command: ["node", "ws-server.mjs"]

    db:
        image: postgres:16
        container_name: digitalstage_db
        restart: unless-stopped
        environment:
            POSTGRES_USER: digitalstage
            POSTGRES_PASSWORD: digitalStage123
            POSTGRES_DB: digitalstage
        volumes:
            - db-data:/var/lib/postgresql/data

    registry:
        image: registry:2
        container_name: digitalstage_registry
        restart: unless-stopped
        expose: [ "5000" ]
        volumes:
            - registry-data:/var/lib/registry

    caddy:
        image: caddy:2
        container_name: digitalstage_caddy
        restart: unless-stopped
        ports:
            - "80:80"
            - "443:443"
        volumes:
            - ./Caddyfile:/etc/caddy/Caddyfile
            - /opt/digitalstage/hls:/srv/hls:ro
            - caddy-data:/data
            - caddy-config:/config
        depends_on: [ app, registry ]

    ffmpeg:
      image: jrottenberg/ffmpeg:6.1-alpine
      container_name: digitalstage_ffmpeg
      restart: unless-stopped
      volumes:
        - /opt/digitalstage/hls:/hls
        - /opt/digitalstage/sdp:/sdp
      entrypoint: [ "/bin/sh", "-c" ]
      ports:
        - "5004-5104:5004-5104/udp"
      command: |
        set -eu

        until [ -s /sdp/input.sdp ]; do
          echo "[ffmpeg] waiting for /sdp/input.sdp..."
          sleep 1
        done

        run_live() {
          exec ffmpeg -hide_banner -loglevel warning \
            -protocol_whitelist file,udp,rtp \
            -analyzeduration 5M -probesize 5M \
            -fflags nobuffer -flags low_delay \
            -rw_timeout 2000000 \
            -i /sdp/input.sdp \
            -filter_complex "\
              [0:v:0]setpts=PTS-STARTPTS,scale=1280:720:force_original_aspect_ratio=decrease,pad=1280:720:(ow-iw)/2:(oh-ih)/2,fps=30[v0];\
              [0:v:1]setpts=PTS-STARTPTS,scale=1280:720:force_original_aspect_ratio=decrease,pad=1280:720:(ow-iw)/2:(oh-ih)/2,fps=30[v1];\
              [0:v:2]setpts=PTS-STARTPTS,scale=1280:720:force_original_aspect_ratio=decrease,pad=1280:720:(ow-iw)/2:(oh-ih)/2,fps=30[v2];\
              [0:v:3]setpts=PTS-STARTPTS,scale=1280:720:force_original_aspect_ratio=decrease,pad=1280:720:(ow-iw)/2:(oh-ih)/2,fps=30[v3]" \
            \
            -map "[v0]" -map 0:a:0? \
            -c:v libx264 -pix_fmt yuv420p -preset veryfast -tune zerolatency \
            -g 60 -keyint_min 60 -sc_threshold 0 \
            -c:a aac -b:a 128k -ar 48000 \
            -f hls -hls_time 2 -hls_list_size 3 -hls_flags delete_segments+independent_segments \
            -hls_segment_filename "/hls/screen_%05d.ts" /hls/screen.m3u8 \
            \
            -map "[v1]" -map 0:a:1? \
            -c:v libx264 -pix_fmt yuv420p -preset veryfast -tune zerolatency \
            -g 60 -keyint_min 60 -sc_threshold 0 \
            -c:a aac -b:a 128k -ar 48000 \
            -f hls -hls_time 2 -hls_list_size 3 -hls_flags delete_segments+independent_segments \
            -hls_segment_filename "/hls/presenter_%05d.ts" /hls/presenter.m3u8 \
            \
            -map "[v2]" -map 0:a:2? \
            -c:v libx264 -pix_fmt yuv420p -preset veryfast -tune zerolatency \
            -g 60 -keyint_min 60 -sc_threshold 0 \
            -c:a aac -b:a 128k -ar 48000 \
            -f hls -hls_time 2 -hls_list_size 3 -hls_flags delete_segments+independent_segments \
            -hls_segment_filename "/hls/questioner_%05d.ts" /hls/questioner.m3u8 \
            \
            -map "[v3]" -map 0:a:3? \
            -c:v libx264 -pix_fmt yuv420p -preset veryfast -tune zerolatency \
            -g 60 -keyint_min 60 -sc_threshold 0 \
            -c:a aac -b:a 128k -ar 48000 \
            -f hls -hls_time 2 -hls_list_size 3 -hls_flags delete_segments+independent_segments \
            -hls_segment_filename "/hls/organizer_%05d.ts" /hls/organizer.m3u8
        }

        run_placeholder_10s() {
          ffmpeg -hide_banner -loglevel warning -t 10 \
            -f lavfi -i color=c=black:s=1280x720:r=30 \
            -f lavfi -i anullsrc=channel_layout=stereo:sample_rate=48000 \
            -f lavfi -i color=c=black:s=1280x720:r=30 \
            -f lavfi -i anullsrc=channel_layout=stereo:sample_rate=48000 \
            -f lavfi -i color=c=black:s=1280x720:r=30 \
            -f lavfi -i anullsrc=channel_layout=stereo:sample_rate=48000 \
            -f lavfi -i color=c=black:s=1280x720:r=30 \
            -f lavfi -i anullsrc=channel_layout=stereo:sample_rate=48000 \
            \
            -map 0:v -map 1:a \
            -c:v libx264 -pix_fmt yuv420p -preset veryfast -tune zerolatency \
            -g 60 -keyint_min 60 -sc_threshold 0 \
            -c:a aac -b:a 128k -ar 48000 \
            -f hls -hls_time 2 -hls_list_size 3 -hls_flags delete_segments+independent_segments \
            -hls_segment_filename "/hls/screen_%05d.ts" /hls/screen.m3u8 \
            \
            -map 2:v -map 3:a \
            -c:v libx264 -pix_fmt yuv420p -preset veryfast -tune zerolatency \
            -g 60 -keyint_min 60 -sc_threshold 0 \
            -c:a aac -b:a 128k -ar 48000 \
            -f hls -hls_time 2 -hls_list_size 3 -hls_flags delete_segments+independent_segments \
            -hls_segment_filename "/hls/presenter_%05d.ts" /hls/presenter.m3u8 \
            \
            -map 4:v -map 5:a \
            -c:v libx264 -pix_fmt yuv420p -preset veryfast -tune zerolatency \
            -g 60 -keyint_min 60 -sc_threshold 0 \
            -c:a aac -b:a 128k -ar 48000 \
            -f hls -hls_time 2 -hls_list_size 3 -hls_flags delete_segments+independent_segments \
            -hls_segment_filename "/hls/questioner_%05d.ts" /hls/questioner.m3u8 \
            \
            -map 6:v -map 7:a \
            -c:v libx264 -pix_fmt yuv420p -preset veryfast -tune zerolatency \
            -g 60 -keyint_min 60 -sc_threshold 0 \
            -c:a aac -b:a 128k -ar 48000 \
            -f hls -hls_time 2 -hls_list_size 3 -hls_flags delete_segments+independent_segments \
            -hls_segment_filename "/hls/organizer_%05d.ts" /hls/organizer.m3u8
        }

        while true; do
          echo "[ffmpeg] trying LIVE..."
          if run_live; then
            echo "[ffmpeg] LIVE exited (unexpected). retry..."
          else
            echo "[ffmpeg] LIVE failed (likely no packets / no keyframe) -> PLACEHOLDER 10s"
            run_placeholder_10s || true
          fi
          sleep 1
        done




volumes:
  db-data:
  registry-data:
  caddy-data:
  caddy-config:
