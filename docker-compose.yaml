services:
    app:
        image: digitalstage.liveroom.at/digitalstage-app:latest
        container_name: digitalstage_app
        restart: unless-stopped
        env_file:
            - .env
        environment:
            # DB-URL für Prisma / Next.js
            - DATABASE_URL=postgresql://digitalstage:digitalStage123@db:5432/digitalstage
        expose:
            - "3000"          # nur intern für Caddy sichtbar
        depends_on:
            - db
        command: sh -c "npx prisma migrate deploy && npm start"

    websocket:
        image: digitalstage.liveroom.at/digitalstage-websocket:latest
        container_name: digitalstage_websocket
        restart: unless-stopped
        env_file:
            - .env
        depends_on:
            - db
        volumes:
            - ./certs:/app/certs:ro
            - /opt/digitalstage/hls:/hls
            - /opt/digitalstage/sdp:/sdp
        ports:
            - "3010"
            - "40000-40100:40000-40100"
        command: ["node", "ws-server.mjs"]

    db:
        image: postgres:16
        container_name: digitalstage_db
        restart: unless-stopped
        environment:
            POSTGRES_USER: digitalstage
            POSTGRES_PASSWORD: digitalStage123
            POSTGRES_DB: digitalstage
        volumes:
            - db-data:/var/lib/postgresql/data

    registry:
        image: registry:2
        container_name: digitalstage_registry
        restart: unless-stopped
        expose:
            - "5000"          # nur intern, Caddy geht drauf
        volumes:
            - registry-data:/var/lib/registry

    caddy:
        image: caddy:2
        container_name: digitalstage_caddy
        restart: unless-stopped
        ports:
            - "80:80"
            - "443:443"
        volumes:
            - ./Caddyfile:/etc/caddy/Caddyfile
            - caddy-data:/data
            - caddy-config:/config
            - /opt/digitalstage/hls:/hls
        depends_on:
            - app
            - registry

    # Ausschnitt für den FFmpeg-Konverter-Service
    # HINWEIS: Der FFmpeg-Befehl muss möglicherweise angepasst werden, um mehrere Streams
    # (cam, screen, audio) gleichzeitig zu verarbeiten. Aktuell wird die SDP-Datei mit allen
    # drei Streams gelesen, aber der Output-Befehl muss entsprechend konfiguriert werden.
    ffmpeg:
        image: digitalstage.liveroom.at/digitalstage-ffmpeg:latest
        container_name: digitalstage_ffmpeg
        restart: unless-stopped
        depends_on:
            -   websocket
        command: >
            ffmpeg -protocol_whitelist file,udp,rtp -timeout 0 -i /sdp/input.sdp 
            -c:v libx264 -preset veryfast -crf 23 -c:a aac -b:a 128k 
            -f hls -hls_time 4 -hls_list_size 5 -hls_flags delete_segments 
            -hls_segment_filename /hls/%v/seg_%05d.ts 
            -master_pl_name /hls/master.m3u8 
            -var_stream_map "v:0 v:1 a:0" 
            /hls/%v/index.m3u8
        # Offenlegung des UDP-Ports (wichtig für die Kommunikation mit Mediasoup,
        # falls sie nicht im gleichen internen Netzwerk sind, aber hier meist unnötig)
        # ports:
        #  - "5004:5004/udp"
        volumes:
            - /opt/digitalstage/hls:/hls
            - /opt/digitalstage/sdp:/sdp

volumes:
    db-data:
    registry-data:
    caddy-data:
    caddy-config:
    hls_data:
