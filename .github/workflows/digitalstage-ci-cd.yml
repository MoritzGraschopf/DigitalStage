name: DigitalStage CI/CD

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  test:
    name: Test (Next.js + Compose Config)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 24
          cache: 'npm'
          cache-dependency-path: |
            package-lock.json

      - name: Create .env from secrets (for build + compose config)
        run: |
          cat > .env << 'ENVEOF'
          DATABASE_URL=${{ secrets.DATABASE_URL }}
          JWT_SECRET=${{ secrets.JWT_SECRET }}
          NEXT_PUBLIC_WS_URL=${{ secrets.NEXT_PUBLIC_WS_URL }}
          NEXT_PUBLIC_STUN_URL=${{ secrets.NEXT_PUBLIC_STUN_URL }}
          ANNOUNCED_IP=${{ secrets.ANNOUNCED_IP }}
          MEDIASOUP_MIN_PORT=${{ secrets.MEDIASOUP_MIN_PORT }}
          MEDIASOUP_MAX_PORT=${{ secrets.MEDIASOUP_MAX_PORT }}
          MEDIASOUP_LISTEN_IP=${{ secrets.MEDIASOUP_LISTEN_IP }}
          NODE_ENV=${{ secrets.NODE_ENV }}
          ENVEOF

      # ✅ Nur Syntax der Compose-Datei prüfen (sehr schnell)
      - name: Validate docker compose config
        run: docker compose -f docker-compose.yaml config

      # ✅ Next.js App normal builden (ohne Docker)
      - name: Install app deps
        run: npm ci

      - name: Build app
        run: npm run build

      # (Optional) Websocket minimal checken, wenn du magst:
      # - name: Check websocket syntax
      #   run: node --check path/zur/deiner/websocket.mjs

  deploy:
    name: Deploy to Debian Server
    needs: test
    runs-on: ubuntu-latest
    if: github.event_name == 'push'   # nur bei Push auf main

    steps:
      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SERVER_SSH_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          printf "Host server\n  HostName %s\n  User %s\n  IdentityFile ~/.ssh/id_ed25519\n  StrictHostKeyChecking no\n" \
            "${{ secrets.SERVER_HOST }}" "${{ secrets.SERVER_USER }}" >> ~/.ssh/config

      - name: Deploy via SSH (git pull + .env schreiben + docker compose up)
        run: |
          ssh server << 'EOF'
          set -e
          cd /opt/digitalstage

          echo ">>> Pulling latest main..."
          git fetch origin
          git reset --hard origin/main

          echo ">>> Rewriting .env from GitHub Secrets..."
          cat > .env << 'ENVEOF'
          DATABASE_URL=${{ secrets.DATABASE_URL }}
          JWT_SECRET=${{ secrets.JWT_SECRET }}
          NEXT_PUBLIC_WS_URL=${{ secrets.NEXT_PUBLIC_WS_URL }}
          NEXT_PUBLIC_STUN_URL=${{ secrets.NEXT_PUBLIC_STUN_URL }}
          ANNOUNCED_IP=${{ secrets.ANNOUNCED_IP }}
          MEDIASOUP_MIN_PORT=${{ secrets.MEDIASOUP_MIN_PORT }}
          MEDIASOUP_MAX_PORT=${{ secrets.MEDIASOUP_MAX_PORT }}
          MEDIASOUP_LISTEN_IP=${{ secrets.MEDIASOUP_LISTEN_IP }}
          NODE_ENV=${{ secrets.NODE_ENV }}
          ENVEOF

          chmod 600 .env

          echo ">>> Building & starting containers on server..."
          docker compose -f docker-compose.yaml up -d --build

          echo ">>> Done."
          EOF
