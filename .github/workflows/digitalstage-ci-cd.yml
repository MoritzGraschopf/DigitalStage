name: DigitalStage CI/CD

on:
  push:
    branches: [ "main" ]

env:
  REGISTRY: digitalstage.liveroom.at
  APP_IMAGE: digitalstage.liveroom.at/digitalstage-app
  WS_IMAGE: digitalstage.liveroom.at/digitalstage-websocket

jobs:
  build-and-push:
    name: Build & Push Images to Private Registry
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Login to registry
        run: |
          echo "${{ secrets.REGISTRY_PASSWORD }}" | docker login ${{ env.REGISTRY }} \
            -u "${{ secrets.REGISTRY_USER }}" --password-stdin

      - name: Build app image
        run: |
          docker build \
            -f docker/Dockerfile \
            -t $APP_IMAGE:latest \
            -t $APP_IMAGE:${{ github.sha }} \
            .

      - name: Build websocket image
        run: |
          docker build \
            -f docker/Dockerfile.ws \
            -t $WS_IMAGE:latest \
            -t $WS_IMAGE:${{ github.sha }} \
            apps/websocket

      - name: Push images
        run: |
          docker push $APP_IMAGE:latest
          docker push $APP_IMAGE:${{ github.sha }}
          docker push $WS_IMAGE:latest
          docker push $WS_IMAGE:${{ github.sha }}

  deploy:
    name: Deploy to Debian Server
    needs: build-and-push
    runs-on: ubuntu-latest

    steps:
      - name: Add SSH key
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SERVER_SSH_KEY }}


      - name: SSH sanity check
        run: |
          ssh -o StrictHostKeyChecking=no ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} "whoami && hostname"

      - name: Deploy via SSH (git + compose + cleanup)
        run: |
          ssh -o StrictHostKeyChecking=no ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} 'bash -s' << EOF
          set -euo pipefail

          cd /opt/digitalstage

          echo ">>> Resetting repo to remote state..."
          git fetch origin
          git reset --hard origin/main

          echo ">>> Writing .env..."
          cat > .env << ENVEOF
          DATABASE_URL=${{ secrets.DATABASE_URL }}
          JWT_SECRET=${{ secrets.JWT_SECRET }}
          NEXT_PUBLIC_WS_URL=${{ secrets.NEXT_PUBLIC_WS_URL }}
          NEXT_PUBLIC_STUN_URL=${{ secrets.NEXT_PUBLIC_STUN_URL }}
          ANNOUNCED_IP=${{ secrets.ANNOUNCED_IP }}
          MEDIASOUP_MIN_PORT=${{ secrets.MEDIASOUP_MIN_PORT }}
          MEDIASOUP_MAX_PORT=${{ secrets.MEDIASOUP_MAX_PORT }}
          MEDIASOUP_LISTEN_IP=${{ secrets.MEDIASOUP_LISTEN_IP }}
          NODE_ENV=${{ secrets.NODE_ENV }}
          FFMPEG_IP=${{ secrets.FFMPEG_IP }}
          ENVEOF
          chmod 600 .env

          echo ">>> Login to registry (for docker pull)..."
          echo "${{ secrets.REGISTRY_PASSWORD }}" | docker login digitalstage.liveroom.at -u "${{ secrets.REGISTRY_USER }}" --password-stdin

          echo ">>> Pulling latest images..."
          docker compose -f docker-compose.yaml pull

          echo ">>> Starting containers..."
          docker compose -f docker-compose.yaml up -d

          echo ">>> Cleaning old Docker resources on server..."
          docker container prune -f
          docker image prune -a -f --filter "until=168h"
          docker builder prune -a -f

          echo ">>> Deployment finished successfully."
          EOF
